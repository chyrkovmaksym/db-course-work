# Реалізація інформаційного та програмного забезпечення

В рамках проекту розробляється: 
- SQL-скрипт для створення на початкового наповнення бази даних
- RESTfull сервіс для управління даними

# Реалізація інформаційного та програмного забезпечення

В рамках проекту розробляється: 
- SQL-скрипт для створення на початкового наповнення бази даних
- RESTfull сервіс для управління даними

-- MySQL Script generated by MySQL Workbench
-- Sun Dec 25 07:19:21 2022
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
DROP SCHEMA IF EXISTS `mydb` ;

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `mydb` DEFAULT CHARACTER SET utf8 ;
USE `mydb` ;

-- -----------------------------------------------------
-- Table `mydb`.`answer`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`answer` ;

CREATE TABLE IF NOT EXISTS `mydb`.`answer` (
  `user_id` INT NOT NULL,
  `text` TEXT NOT NULL,
  `data` DATE NOT NULL,
  `id` INT NOT NULL AUTO_INCREMENT,
  `answer_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_selectedOption_id_idx` (`answer_id` ASC) VISIBLE,
  INDEX `fk_user_id_idx` (`user_id` ASC) VISIBLE,
  CONSTRAINT `fk_selectedOption_id`
    FOREIGN KEY (`answer_id`)
    REFERENCES `mydb`.`selectedOption` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_user_id`
    FOREIGN KEY (`user_id`)
    REFERENCES `mydb`.`user` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);


-- -----------------------------------------------------
-- Table `mydb`.`category`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`category` ;

CREATE TABLE IF NOT EXISTS `mydb`.`category` (
  `category_id` INT NOT NULL,
  `name` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`category_id`));


-- -----------------------------------------------------
-- Table `mydb`.`option`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`option` ;

CREATE TABLE IF NOT EXISTS `mydb`.`option` (
  `type` TEXT(255) NOT NULL,
  `text` TEXT(255) NOT NULL,
  `id` INT NOT NULL AUTO_INCREMENT,
  `question_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_question_id_idx` (`question_id` ASC) VISIBLE,
  CONSTRAINT `fk_question_id`
    FOREIGN KEY (`question_id`)
    REFERENCES `mydb`.`question` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);


-- -----------------------------------------------------
-- Table `mydb`.`question`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`question` ;

CREATE TABLE IF NOT EXISTS `mydb`.`question` (
  `type` TEXT(255) NOT NULL,
  `text` TEXT(255) NOT NULL,
  `id` INT NOT NULL AUTO_INCREMENT,
  `topic` TEXT(255) NOT NULL,
  `quiz_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_quiz_id_idx` (`quiz_id` ASC) VISIBLE,
  CONSTRAINT `fk_quiz_id`
    FOREIGN KEY (`quiz_id`)
    REFERENCES `mydb`.`quiz` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);


-- -----------------------------------------------------
-- Table `mydb`.`quiz`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`quiz` ;

CREATE TABLE IF NOT EXISTS `mydb`.`quiz` (
  `type` TEXT(255) NOT NULL,
  `text` TEXT(255) NOT NULL,
  `id` INT NOT NULL AUTO_INCREMENT,
  `topic` TEXT(255) NOT NULL,
  `date` DATETIME NOT NULL,
  `creator_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_creator_id_idx` (`creator_id` ASC) VISIBLE,
  CONSTRAINT `fk_creator_id`
    FOREIGN KEY (`creator_id`)
    REFERENCES `mydb`.`user` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);


-- -----------------------------------------------------
-- Table `mydb`.`selectedOption`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`selectedOption` ;

CREATE TABLE IF NOT EXISTS `mydb`.`selectedOption` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `option_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_option_id_idx` (`option_id` ASC) VISIBLE,
  CONSTRAINT `fk_option_id`
    FOREIGN KEY (`option_id`)
    REFERENCES `mydb`.`option` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);


-- -----------------------------------------------------
-- Table `mydb`.`user`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`user` ;

CREATE TABLE IF NOT EXISTS `mydb`.`user` (
  `username` VARCHAR(16) NOT NULL,
  `mail` VARCHAR(255) NOT NULL,
  `id` INT NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`));


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;

# Реалізація доступу до бази даних

# Підключення до бази даних

```
const mysql = require('mysql');

const connection = mysql.createConnection({
  host: 'localhost',
  user: 'user',
  password: '13124',
  database: 'mydb',
});

module.exports = connection;
```

# API для обробки запитів

```
const { Router } = require('express')
const router = Router()

const connection = require('../db')

const { ERRORS, SUCCESS } = require('../constants')

router.get('/answers', (req, res) => {
  connection.query('select * from answer', (err, answers) => {
    if (err) {
      console.log(err)
      res.status(500).json({
        message: ERRORS.SERVER_ERROR,
      })
      return
    }

    res.status(200).json({
      data: answers,
    })
  })
})

router.get('/answer/:id', (req, res) => {
  const { id } = req.params
  connection.query(`select * from answer where id = ${id}`, (err, [answer]) => {
    if (err) {
      console.log(err)
      res.status(500).json({
        message: ERRORS.SERVER_ERROR,
      })
      return
    }

    if (!answer) {
      res.status(404).json({
        message: ERRORS.NOT_FOUND,
      })
      return
    }

    res.status(200).json({
      data: answer,
    })
  })
})

router.post('/answer', (req, res) => {
  const { user_id, text, data, answer_id } = req.body

  if (!(user_id && text && data && answer_id)) {
    res.status(400).json({
      message: ERRORS.ALL_FIELDS_REQUIRED,
    })
    return
  }

  connection.query(
    `insert into answer (
        user_id,
        text,
        data,
        answer_id
      ) values (
        ${user_id},
        "${text}",
        "${data}",
        ${answer_id}
      )`,
    (err) => {
      if (err) {
        console.log(err)
        res.status(500).json({
          message: ERRORS.SERVER_ERROR,
        })
        return
      }

      res.status(201).json({
        message: SUCCESS.PROJECT_CREATED,
      })
    },
  )
})

router.put('/answer/:id', (req, res) => {
  const { id } = req.params

  connection.query(`select * from answer where id = ${id}`, (err, [answer]) => {
    if (err) {
      console.log(err)
      res.status(500).json({
        message: ERRORS.SERVER_ERROR,
      })
      return
    }

    if (!answer) {
      res.status(404).json({
        message: ERRORS.NOT_FOUND,
      })
      return
    }

    const { user_id, text, data, answer_id } = {
      ...answer,
      ...req.body,
    }

    connection.query(
      `update answer set 
        user_id = ${user_id}, 
        text = "${text}",
        data = "${data}",
        answer_id = ${answer_id}
        where id = ${id}`,
      (err) => {
        if (err) {
          console.log(err);
          res.status(500).json({
            message: ERRORS.SERVER_ERROR,
          })
          return
        }

        res.status(200).json({
          message: SUCCESS.PROJECT_UPDATED,
        })
      },
    )
  })
})

router.delete('/answer/:id', (req, res) => {
  const { id } = req.params
  connection.query(`delete from answer where id = ${id}`, (err) => {
    if (err) {
      console.log(err);
      res.status(500).json({
        message: ERRORS.SERVER_ERROR,
      })
      return
    }

    res.status(200).json({
      message: SUCCESS.PROJECT_DELETED,
    })
  })
})

module.exports = router

```

# Утиліти

```
const decodeId = (bufferArray) => {
  return Buffer.from(bufferArray).toString('hex')
}

module.exports = { decodeId }
```

# Фалз з константами для відповідей з серверу

```
const ERRORS = {
  SERVER_ERROR: 'Error on server. Try later',
  ALL_FIELDS_REQUIRED: 'All fields are required',
  NOT_FOUND: 'Answer was not found. Check the id',
};

module.exports = ERRORS;
```

```
const SUCCESS = {
  PROJECT_CREATED: 'New answer was created',
  PROJECT_UPDATED: 'Answer has been updated',
  PROJECT_DELETED: 'Answer was deleted',
}

module.exports = SUCCESS
```

```
const ERRORS = require('./errors')
const SUCCESS = require('./success')

module.exports = {
  ERRORS,
  SUCCESS,
}
```

# Головний файл серверу

```
const express = require("express");
const cors = require("cors");
const bodyParser = require("body-parser");

const app = express();
const port = 3000;
const host = '0.0.0.0';

const connection = require('./db');

connection.connect();

app.use(cors());
app.use(bodyParser.json());
app.use('/api', require('./controls'));

app.listen(port, host, () => {
  console.log(`Started server: ${host}/${port}`);
});
```